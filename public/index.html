<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bus / Truck App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css"
    rel="stylesheet"
  />

  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { width: 100%; height: 100vh; display: none; }

    #roleSelect {
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 15px;
      justify-content: center;
      align-items: center;
    }

    button {
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #startBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      display: none;
    }
  </style>
</head>
<body>

  <!-- ROLE SELECT -->
  <div id="roleSelect">
    <h2>Kim sifatida kirasiz?</h2>
    <button id="userBtn">ğŸ‘¤ Oddiy user</button>
    <button id="driverBtn">ğŸšš Driver</button>
  </div>

  <!-- DRIVER BUTTON -->
  <button id="startBtn">ğŸ“ My location</button>

  <!-- MAP -->
  <div id="map"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    mapboxgl.accessToken =
      "pk.eyJ1IjoidW1lZGpvbjk5IiwiYSI6ImNtN3Rza3czdDB1bW4yanF5Nmg4Ym1nbmIifQ.0Z5e4Qzn8La43ouMfIxaWg";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/traffic-day-v2",
      center: [69.47, 40.16],
      zoom: 13,
    });

    const drivers = {};
    let myMarker = null;

    const roleSelect = document.getElementById("roleSelect");
    const mapDiv = document.getElementById("map");
    const startBtn = document.getElementById("startBtn");

    // USER
    document.getElementById("userBtn").onclick = () => {
      roleSelect.style.display = "none";
      mapDiv.style.display = "block";

      socket.emit("set-role", "user");
    };

    // DRIVER
    document.getElementById("driverBtn").onclick = () => {
      roleSelect.style.display = "none";
      mapDiv.style.display = "block";
      startBtn.style.display = "block";

      socket.emit("set-role", "driver");
    };

    // DRIVER BUTTON
    startBtn.onclick = () => {
      navigator.geolocation.watchPosition((pos) => {
        const { latitude, longitude } = pos.coords;

        socket.emit("send-location", { latitude, longitude });

        if (!myMarker) {
          myMarker = new mapboxgl.Marker({ color: "blue" })
            .setLngLat([longitude, latitude])
            .addTo(map);
        } else {
          myMarker.setLngLat([longitude, latitude]);
        }

        map.flyTo({ center: [longitude, latitude], zoom: 16 });
      });
    };

    // USER â€” DRIVERLARNI KOâ€˜RADI
    socket.on("driver-location", ({ id, latitude, longitude }) => {
      if (!drivers[id]) {
        drivers[id] = new mapboxgl.Marker({ color: "red" })
          .setLngLat([longitude, latitude])
          .addTo(map);
      } else {
        drivers[id].setLngLat([longitude, latitude]);
      }
    });

    socket.on("driver-disconnected", (id) => {
      if (drivers[id]) {
        drivers[id].remove();
        delete drivers[id];
      }
    });
  </script>
</body>
</html>
